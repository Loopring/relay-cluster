# Loopring Relay（中继）中文文档
“中继”是路印协议技术生态的重要组成部分，主要功能包括：管理链外订单池、广播订单、撮合订单，同时向去中心化交易所和上层钱包等入口提供完整的后端服务。其在中心化系统的基础上，通过广播订单的概念，将所有订单广播到其他中继，实现了全网共享订单池。本文档将重点介绍中继如何工作、如何接入、如何部署这三部分内容。

## 部署文档
* [aws部署文档](deploy/deploy_index_cn.md)
* [docker部署文档](relay_docker_cn.md)

***

## 目录

- [词汇表](#词汇表)
- [中继如何工作](#中继如何工作)
  * [路印生态](#路印生态)
  * [系统架构](#系统架构)
  * [钱包后台](#钱包后台)
  * [交易所后台](#交易所后台)
  * [以太坊解析](#以太坊解析服务)
  * [撮合服务](#交易和撮合服务)
- [功能介绍](#功能介绍)
  * [订单管理](#订单管理)
  * [账户管理](#账户管理)
  * [交易&撮合](#交易与撮合)
  * [交易所行情](#交易所行情)
  * [元信息](#元信息管理)
- [如何接入中继](#如何接入中继)
  * [jsonrpc](#jsonrpc)
  * [socketio](#socketio)
  * [sdk](#sdk)
  * [测试环境](#测试环境)
- [如何部署中继](#如何部署中继)
- [github](#github)
- [微服务介绍](#微服务介绍)
- [获取帮助](#获取帮助)

---

## 词汇表

分类 | 名词 | 解释
------|------|------
| 订单 | Order | 符合Loopring protocol格式的订单数据。
订单 | OrderHash | 订单的签名，由订单部分字段进行散列算法后生成的摘要。
订单 | Owner | 订单的所有者，即用户的钱包地址。
订单 | OrderType | 订单类型，中继支持两种订单类型: market_order( 市场订单)是整个交易所订单池共享的订单，可以被任何人成交；p2p_order(点对点订单)是不包含钱包认证私钥的订单，只能被授权共享了钱包认证私钥的用户才能撮合，且点对点订单不会展示到最新挂单之中。
订单 | WalletAddress | 分润地址，通常是钱包或交易所等产品研发团队的地址，用来接收订单成功撮合后的利润分成，目前的方案是：钱包或交易所获得整个撮合利润的20%，撮合者(Miner)则获得剩余的80%。
订单 | AuthAddr & AuthPrivateKey | 用来防止订单或环路被篡改，AuthAddr用来给订单签名，AuthPrivateKey则用来给环路签名，同时在p2p交易的场景下，将订单通过二维码分享给指定用户时，AuthPrivateKey还可以保护订单只被对方成交。
订单 | TokenS | 欲出售的Token, 参考Token列表（token.json）
订单 | TokenB | 欲买入的Token，参考Token列表（token.json）
订单 | AmountS | 欲出售的Token数量
订单 | AmountB | 欲买入的Token数量
订单 | ValidSince | 订单生效开始时间，采用时间戳表示，若当前时间小于ValidSince，则订单处于未生效状态。
订单 | ValidUntil | 订单有效截止时间，采用时间戳表示，超过该时间后订单将自动失效。
订单 | LrcFee | 设置该笔订单撮合需要的LrcFee
订单 | buyNoMoreThanAmountB | 是否允许购买超过amountB数量的tokeB，例如：当前市场LRC-WETH的卖价是0.001，某用户以0.002的价格下单买入100个（消耗0.2个WETH），如果buyNoMoreThanAmountB=true，最终用户会以0.001的价格（不考虑撮合收益）购买到100个LRC，仅消耗0.1个WETH；但如果buyNoMoreThanAmountB=false，则会消耗掉该用户所有的WETH（0.2个）以0.001的价格（不考虑撮合收益）购买到200个LRC。
订单 | marginSplitPercentage | 撮合分润中用来支付撮合费的比例，通常默认是50%。
订单 | v, r, s | 订单签名的结果，先对订单部分字段采用Keccak256算法生成OrderHash, 再对OrderHash做ECDSA签名的结果。
订单 | powNonce | 订单提交工作量证明，为了防止订单子系统被spam，我们采用工作量证明的方式来限制过多的订单提交，powNonce会参与工作量证明算法的计算，订单通过算法校验后被提交到中继，中继接收到订单后会以相同的算法来校验nonce是否通过了工作量证明。
订单 | 撮合 | 两个以上订单满足形成Loopring环路的条件，可形成环形成交，环形成交即Loopring的撮合。
订单 | 环路 | 相比传统交易所订单两两互相成交的方式，Loopring可针对多笔订单串联，形成环形成交队列，这个头尾相连的环形订单队列就统称为环路。
订单 | 软取消 | 在初期版本的钱包中，用户取消订单只能提交到智能合约进行处理，不仅花费油费，而且还不能即时取消。后来在Relay中开发了软取消功能，在满足软取消情况(比如订单未撮合或者未在撮合流程中)下，可通过Relay取消订单，不消耗油费，还能即时取消订单。
账户 | Allowance | 代币授权，用户授权给Loopring protocol，只有对智能合约进行授权后，合约才有权撮合用户的订单。
账户 | Balance | 用户资产余额，ETH余额和所有ERC20 Token余额的总和。
账户 | WETH | 以太坊上锚定ETH的ERC20 Token，由于路印智能合约只支持ERC20 Token之间的资产交换，而ETH并非ERC20 Token，所以在交易前需将ETH转换为WETH，同时对WETH进行代币授权，WETH与ETH之间为等量交换（除了一笔油费）。
市场 | Fill | 成交信息，环路撮合后，由智能合约发出的成交数据Event
市场 | Depth | 市场深度
市场 | Ticker | 24小时市场变化统计数据
市场 | Trend | 市场变化趋势信息，目前支持最小维度1Hr
市场 | RingMined | Order组成的环路撮合的结果
市场 | Cutoff | 用户以地址为单位设置的订单全部失效时间点，cutoff时间点之前的订单，全部变为无效订单
市场 | PriceQuote | 各个币种的市价参考，目前支持BTC, CNY, USD
合约 | LoopringProtocolImpl | Loopring入口合约地址，伴随着合约升级，地址会有变化
合约 | DelegateAddress | Delegate合约地址，订单池按照Delegate合约划分，不同Delegate地址的订单之间，不能互相撮合。
通用 | Token | 即以太坊上代币，目前只支持完全符合ERC20标准的Token
通用 | Transaction | 指用户转账/授权/合约调用等以太坊交易操作，在Relay中，对transaction进行了封装，包含了用户订单撮合类型与所有以太坊交易操作类型，方便用户区分。
通用 | Gas | 提交一笔交易需要指定GasPrice和GasLimit，用来支付交易产生的费用，Loopring支持获取当前网络最佳GasPrice
通用 | Nonce | 以用户钱包地址为单位，从0开始递增的整数，当前值等于用户提交成功的transaction总数，用户提交transaction需要提供nonce做校验，同一个nonce只能有一个transaction提交成功，由于Relay接入了Loopring众多的钱包版本（web/ios/android）, 同时有多个合作伙伴接入，所以提供了集中维护Nonce的功能，最大程度的提高transaction成功率。
通用 | Miner | Loopring撮合服务，在订单池中发现环路，并提交到智能合约进行撮合。
通用 | Decimal | ERC20 Token 单位精度，一般情况下订单的Token数量除以Decimal等于实际数量，通常Decimal=1e18。
通用 | Symbol | Token简称，例如Loopring ERC20 Token成为“LRC”。

---

## 中继如何工作

### 基本原理
路引协议从基本构造上可拆解为“链上清算”与“链下撮合”两个部分，其中链上清算是基于智能合约来完成，而链下撮合则由后端中继来完成。每一个中继都维护着一个独立的订单池，为了提供更高的代币流动性，中继之间可通过不断广播的方式来进行订单交换和订单共享，最终实现全网订单的互通有无。

---

### 系统架构
中继作为钱包与交易所的后端系统，具有合乎常理的中心化系统分层架构，主要分为如下四层：

* 系统接入层：对外提供钱包和交易所服务的接口层，支持jsonrpc 2.0 和socketio。
* 业务逻辑层：包含各个业务逻辑接口和具体实现。
* 存储层：包含缓存和持久化存储，缓存接入Redis，持久化存储我们同时选择了kv存储(Redis)和关系型存储系统(Mysql)两种方式, 其中Redis用来存储适合kv查询并且对查询性能要求比较高的数据，如用户余额等，而Mysql则用来存储查询相对复杂的数据，如用户的订单/交易信息等。
* 广播层：用来传播订单。

---

### 钱包后台
该服务用来支撑钱包相关的功能，包括用户余额、授权额度、交易数据、钱包nonce和cutoff信息等。

---

### 交易所后台
该服务用来支撑交易所相关的功能，包括交易所订单池、成交信息、环路信息、市场趋势图/k线数据、深度/orderbook、 全球/第三方交易所行情等。

---

### 基础服务
提供中继与以太坊的一些基础配置信息，包括以太坊预估gasPrice、中继支持的合约列表、中继支持的代币列表、交易对列表等。

---

### 以太坊解析服务
监听链上block/transaction/event等原始数据，同时解析交易和事件，形成业务分类，将链上数据持久化并且缓存到中继，并根据交易或事件更新用户的余额、订单、成交信息等。解析服务同时还要处理频繁发生的以太坊分叉。

---

### 交易与撮合服务
根据白皮书的描述，每笔交易都需要经过链下撮合与链上清算两个步骤才算完成，链下撮合即Miner在链下发现环路，链上清算即Miner将发现的环路提交到智能合约进行上链结算，并将交易所得代币分发给交易双方及分润地址。撮合服务即发现环路并提交给智能合约的服务。

---

## 功能介绍

### 管理订单
管理订单生命周期，处理用户和以太坊针对订单的更新操作，并向用户和其他子系统提供不同类型的查询接口。

#### 提交订单
处理来自用户的订单、订阅其他中继来源的订单。

##### 校验订单
订单在持久化之前，需要经过一系列的校验，才能成功被持久化：
```
1. 工作量证明校验(暂未启用)
2. 基础校验，规则：amountS最小数量和最小法币数量限制;最晚生效时间限制(不能晚于某个时间点生效，当前设置为不能晚于订单提交时间10小时);分润比例必须在0-1之间;账户地址和Token地址合法性校验等
3. 验证签名，根据v, r, s获取签名地址，验证其是否与钱包地址一致
4. 校验是否是支持的token和市场对
5. 校验订单是否过期

```

##### 补全订单
通过一系列校验合格后，将会补全订单的orderHash，price，market等字段，方便后续关系型查询。

##### 持久化订单
最后订单会被持久化到数据库，如果中继设置了广播策略，还会按照该策略将订单广播到其他中继，至此订单提交流程结束。

#### 查询订单
提供了多维度的查询接口，即除最基本的订单列表查询(参见API文档)外，还有基于订单的市场深度的查询和orderbook查询。

> 市场深度是相同价格聚合数量后的结果，orderbook没有对订单做聚合

#### 取消订单
提供两种取消方式：通过智能合约取消、通过中继取消。  
前者直接调用以太坊合约取消订单，需消耗gas。  
后者是调用链下中继接口取消订单，不消耗gas，但有一定概率取消失败，因为广播出去的订单有可能已经被其他中继提交环路，我们正在尽力减少这种取消失败的概率，未来建议都采用后者来取消订单，可大量节省用户成本。

---

### 账户管理
即管理用户以太坊钱包账户，主要工作包括：支持对账户的一系列写操作（如转账/授权/WETH转换等）；支持解析以太坊上每一笔与用户相关的账户操作，实时更新用户余额变化并持久化到内存数据库中；维护用户所有transaction操作记录，方便用户了解操作细节；集中地准确地维护用户最新nonce，采用中继提供的nonce可以最大程度降低以太坊操作失败的概率。

---

### 交易与撮合
Loopring撮合服务(Miner)通过内部RPC接口获取未完结的订单，寻找并发现环路后，提交到以太坊智能合约进行撮合，最终通过以太坊解析服务获取撮合结果，更新订单状态。

---

### 交易所行情
中继向交易所提供一些必要的行情信息（包括深度/orderbook/最新成交/ticker/趋势图/kline等），同时集成了coinmarketcap全球行情，最近还将接入MyToken开放平台，获取并向用户展示更加全面的行情数据。

---
### 元信息管理
包括最佳预估gasPrice的信息、中继目前支持的合约信息(Delegate和Protocol对应关系)、中继支持的交易对列表、Token列表等。

---

## 如何接入中继
目前有3种方式可以接入中继：jsonrpc、socketio、 sdk

### jsonrpc
JSON-RPC是一种基于JSON的跨语言远程调用协议。JSON-RPC非常简单，在请求时向服务器传输数据格式如下(基于JSON2.0):
```
{
    "jsonrpc" : 2.0,
    "method" : "helloLoopring", 
    "params" : [{"key" : "value"}], 
    "id" : 347579
}
```
具体JSONRPC接口接入，请参考[API文档](relay_api_spec_v2.md)。

---

### socketio
SocketIO将底层通信封装成事件编程模型，提供基于事件的长连接通信方式。中继为了提高数据的实时性，也采用了与传统中心化交易所一样的技术手段来提升用户体验，具体socketio接入方法，请参考[API文档](relay_api_spec_v2.md)。

---

### sdk
在网络接口的基础上，我们进一步封装了中继接口调用，形成多个平台的sdk，让开发者通过方法调用接入中继，目前JavaScript版本Loopring.js已经开源，IOS和Java SDK正在研发中，SDK是对JSONRPC和Socketio接口调用的封装。Loopring.js请参考文档[Loopring.js](https://github.com/Loopring/loopring.js/wiki/loopring.js-v2.0.0-%E4%B8%AD%E6%96%87%E5%BC%80%E5%8F%91%E8%80%85%E6%96%87%E6%A1%A3)

---

### 测试环境
目前提供一套完整的测试环境，方便合作伙伴开发和调试Dapp，使用测试环境前，请先知晓以下相关信息

测试环境地址：13.112.62.24，即：

* jsonrpc入口：http://13.112.62.24/rpc/v2
   
* socketio入口：http://13.112.62.24/socket.io
   
* 以太坊测试节点入口：http://13.112.62.24/eth

* web钱包测试环境入口：http://13.112.62.24:8000

> 中继生产环境只支持https, 测试环境只支持http

钱包接入中继前，需先配置中继与以太坊节点的相关信息，这些配置项在主网和测试环境中并不相同，这里介绍测试环境中的各个配置项：

```
DelegateAddress     - 请参考词汇表，测试环境地址：0xa0af16edd397d9e826295df9e564b10d57e3c457
ProtocolImplAddress - 请参考词汇表，测试环境地址：0x456044789a41b277f033e4d79fab2139d69cd154
walletAddress       - 钱包分润地址，钱包自己设置
chainId             - 以太坊EIP155引入，为了防止重放攻击，测试环境值：7107171
tokens List         - 钱包配置的token列表，包含token详细信息，也可以通过loopring_getLooprSupportedTokens获取中继支持的token列表

```
---

### 生产环境

生产环境为官方中继，生产环境地址：https://relay1.loopring.io/ ，即：

* jsonrpc入口：https://relay1.loopring.io/rpc/v2
   
* socketio入口：https://relay1.loopring.io/socket.io
   
* 以太坊节点入口：https://relay1.loopring.io/eth

> 中继生产环境只支持https, 测试环境只支持http

---

## 如何部署中继
目前提供两种部署方式：[aws部署](deploy/deploy_index_cn.md)、[docker部署](relay_docker_cn.md)，请仔细阅读部署文档。

中继是一个完整的企业级分布式应用，虽然目前系统体量比较小，仅包含3个微服务，但同其他分布式应用一样，具有如下几个特点：

* 基于aws ALB提供完整的负载均衡策略
* 部署了高可用的kafka&zookeeper集群 
* 采用了aws redis主备模式缓存集群和mysql存储集群
* 有多达200+完善的cloudwatch监控配置项
* 支持aws codedeploy的一键部署脚本
* 针对每个可能出点单点故障或者系统其他问题的地方，做了相应的灾备和容错处理

部署一个高可用的中继，需要非常专业的工程师做大量系统工作并长期维护，建议具有一定研发实力的合作伙伴来部署分布式中继，我们会尽可能提供部署指导。

---

## github
中继包含以下几个github库, 简单介绍下各个库的作用：
* relay-cluster : 中继cluster版本，提供wallet和DEX后台服务
* miner : 撮合服务
* extractor : 以太坊解析服务
* relay-lib : 基础库，供以各个微服务系统使用

---

## 配置文件
中继包含两个配置文件：relay.toml和tokens.json, 前者是中继全局配置，后者是用来指定中继支持的Token列表和市场。
relay.toml配置项较多，针对relay.toml中比较重要的不太容易理解配置项做如下说明：
```
websocket      - 中继对外socketio端口
jsonrpc        - 中继对外jsonrpc端口
ipfs & gateway - 消息广播的配置，消息广播代码已经被注释，可以先不配置
accessor       - 以太坊网络节点url， 数组，可以支持同时访问多个
extractor.start_block_number   - 中继启动时从哪个块开始处理，建议第一次启动时，改成最新的块，减少不必要的块同步
extractor.confirm_block_number - 经过多少个块确认后，extractor才真正将transaction消息事件发出去供其他模块消费， 这里最好是1
common abi     - 包含ERC20标准ABI，WETH ABI以及Loopring合约ABI配置，如果是链接主网，可以不用修改
gateway filter - 用来配置提交订单各种校验规则
miner          - 以miner模式启动时，配置挖矿参数
```

官方会进一步更新relay.toml配置文件，添加注释，做到自解释。

---

## 微服务介绍

* #### relay-cluster
relay-cluster和之前单节点版本relay功能基本相同，为钱包和DEX应用提供后台服务，将原来在单节点版本relay中的撮合服务和以太坊解析服务剥离出去，就是目前relay-cluster提供的功能。

* #### miner
撮合服务，接收订单，发现环路，提交环路到以太坊网络，通过rpc服务于relay-cluster通信

* #### extractor
以太坊解析服务，以太坊上发生的每一笔transaction，每一个event等，都是通过extractor解析，然后包装成事件，通过消息队列(目前是kafka)，提供给relay-cluster和miner使用

---

## 获取帮助
请访问Loopring官网：https://loopring.org ，获取联系方式并寻求帮助
